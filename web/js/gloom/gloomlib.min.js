(function(){var d=function(b,c){return function(){return b.apply(c,arguments)}},a=function(b){var c=this;this.displayProgress=d(this.displayProgress,this);this.onstop=d(this.onstop,this);this.onresume=d(this.onresume,this);this.onpause=d(this.onpause,this);this.onplay=d(this.onplay,this);this.$container=$(b);this.$controlsContainer=$(".player-controls",this.$container);this.$progressContainer=$(".player-progress-container",this.$container);this.$progressBar=$(".player-progress-bar",this.$container);
this.$progressText=$(".player-progress-text",this.$container);this.$playBtn=$(".player-play",this.$container);this.$stopBtn=$(".player-stop",this.$container);this.$pauseBtn=$(".player-pause",this.$container);this.$stopBtn.click(function(){return c.stop()});this.$pauseBtn.click(function(){return c.pause()});this.$playBtn.click(function(){return"paused"===c.current?c.resume():c.play()});this.$progressContainer.click(function(b){b=(b.clientX-c.$progressContainer.offset().left)/c.$progressContainer.width();
return"function"===typeof c.progressCallback?c.progressCallback(b):void 0})};a.prototype.on=function(b,c){return this[b+"Callback"]=c};a.prototype.onplay=function(){this.$playBtn.hide();this.$pauseBtn.show();return"function"===typeof this.playCallback?this.playCallback():void 0};a.prototype.onpause=function(){this.$pauseBtn.hide();this.$playBtn.show();return"function"===typeof this.pauseCallback?this.pauseCallback():void 0};a.prototype.onresume=function(){this.$playBtn.hide();this.$pauseBtn.show();
return"function"===typeof this.resumeCallback?this.resumeCallback():void 0};a.prototype.onstop=function(){this.$pauseBtn.hide();this.$playBtn.show();return"function"===typeof this.stopCallback?this.stopCallback():void 0};a.prototype.displayProgress=function(b){var c=b.current;b=b.total;c=Math.min(c,b);var a=c/b;this.$progressBar.width(this.$progressContainer.width()*a);c=this._formatTime(c);b=this._formatTime(b);return this.$progressText.text(c+" / "+b)};a.prototype._formatTime=function(b){var c=
b/60>>0;b=String(b-60*c>>0);1===b.length&&(b="0"+b);return c+":"+b};StateMachine.create({target:a.prototype,events:[{name:"init",from:"none",to:"ready"},{name:"play",from:"ready",to:"playing"},{name:"pause",from:"playing",to:"paused"},{name:"resume",from:"paused",to:"playing"},{name:"stop",from:"*",to:"ready"}]});this.PlayerWidget=a}).call(this);
(function(){var d=function(b,c){return function(){return b.apply(c,arguments)}},a=function(){var b=this;this.setProgressFrom=d(this.setProgressFrom,this);this.setProgress=d(this.setProgress,this);this.setCurrentTime=d(this.setCurrentTime,this);this.getEndTime=d(this.getEndTime,this);this.pause=d(this.pause,this);this.stop=d(this.stop,this);this.resume=d(this.resume,this);this.start=d(this.start,this);this.fretnote=new FretNote(21,0);this.fretboard=new FretBoard("#fretboard",this.fretnote);this.tablature=
new Tablature("#svg");this.technical=new TechnicalNotes(this.fretnote);this.player=MIDI.Player;this.player.addListener(function(c){var a=c.technical;c=c.message;if(144===c)return b.fretboard.press(a);if(128===c&&null!=a)return b.fretboard.release(a)});this.player.setAnimation(function(c){var a=c.now;c=c.end;a>=c&&setTimeout(b._stop_player,1E3);b.tablature.update(1E3*a);return"function"===typeof b.onprogress?b.onprogress({current:a,total:c}):void 0})};a.prototype._stop_player=function(){return window.player.stop()};
a.prototype.initMidi=function(b,c){return MIDI.loadPlugin({instrument:b,onsuccess:function(){"acoustic_guitar_steel"===b?MIDI.programChange(0,25):"acoustic_guitar_nylon"===b&&MIDI.programChange(0,24);MIDI.channels[9].mute=!0;return"function"===typeof c?c():void 0}})};a.prototype.loadMidiFile=function(b,c){var a=this;this.player.BPM=90;return this.technical.init("./songs/notes.Crying_in_the_rain.xml",function(){return a.player.loadFile(b,function(){return a.tablature.setMidiData(a.player.data,c)})})};
a.prototype.start=function(){this.player.start();return this.playing=!0};a.prototype.resume=function(){this.player.currentTime+=1E-6;this.player.resume();return this.playing=!0};a.prototype.stop=function(){this.player.stop();this.fretboard.release_all();return this.playing=!1};a.prototype.pause=function(){this.player.pause();return this.playing=!1};a.prototype.getEndTime=function(){return this.player.endTime};a.prototype.setCurrentTime=function(b){this.player.pause();this.player.currentTime=b;if(this.playing)return this.player.resume()};
a.prototype.setProgress=function(b){return this.setCurrentTime(this.player.endTime*b)};a.prototype.setProgressFrom=function(b){this.fretboard.release_all();return this.setCurrentTime(this.player.currentTime+b)};a.prototype.on=function(b,c){return this["on"+b]=c};this.Gloom=a}).call(this);
(function(){var d=function(a,b){var c,g,f;this.nb_frets=void 0===a?21:a;this.capodaster=void 0===b?0:b;var m=this.strings=[{note:64,num:1,notes:[]},{note:59,num:2,notes:[]},{note:55,num:3,notes:[]},{note:50,num:4,notes:[]},{note:45,num:5,notes:[]},{note:40,num:6,notes:[]}];var d=0;for(g=m.length;d<g;d++){var e=m[d];var l=c=0;for(f=this.nb_frets;0<=f?c<=f:c>=f;l=0<=f?++c:--c)e.notes.push(e.note+l)}};d.prototype.noteToFret=function(a){var b,c,g,f;var d=b=g=this.capodaster;for(f=this.nb_frets;g<=f?b<=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               f:b>=f;d=g<=f?++b:--b){var h=this.strings;var e=0;for(c=h.length;e<c;e++){var l=h[e];if(a===l.notes[d])return{string:l.num,fret:d}}}};d.prototype.technicalNote=function(a){return this.strings[a.string-1].notes[a.fret]};this.FretNote=d}).call(this);
(function(){var d=function(a,b){var c,g;this.fretnote=b;this.model=Snap(a);this.note_elm=[];for(g=c=1;6>=c;g=++c)this.note_elm[g]=[]};d.prototype.init=function(a){var b=this;Snap.load("./img/fretboard.svg",function(c){var a,f,d,h;for(h=a=1;6>=a;h=++a){var e=f=0;for(d=b.fretnote.nb_frets;0<=d?f<=d:f>=d;e=0<=d?++f:--f){var l="#f"+h+"-"+e;b.note_elm[h][e]=c.select(l)}}return b.model.append(c)});return"function"===typeof a?a():void 0};d.prototype.press=function(a){var b=a.string;a=a.fret;this.note_elm[b][a].attr({stroke:"#000",
display:""});return this.note_elm[b][a].animate({fill:"#FF9800"},300)};d.prototype.release=function(a){return this.note_elm[a.string][a.fret].attr({display:"none",fill:"red"})};d.prototype.release_all=function(){var a,b,c;var d=[];for(c=b=1;6>=b;c=++b)d.push(function(){var b,d;var g=[];a=b=0;for(d=this.fretnote.nb_frets;0<=d?b<=d:b>=d;a=0<=d?++b:--b)g.push(this.release({string:c,fret:a}));return g}.call(this));return d};this.FretBoard=d}).call(this);
(function(){var d=function(a,b){return function(){return a.apply(b,arguments)}};this.Tablature=function(){var a=function(b){this.update=d(this.update,this);this._handleTabClick=d(this._handleTabClick,this);var c,a;this.model=Snap(b);var f=c=10;for(a=this.string_offset;70>=c;f=c+=a)this.model.line(0,f,700,f).attr({stroke:"black","stroke-width":"0.15"});this.cursor=this.model.line(this.cursor_init_pos,0,this.cursor_init_pos,80).attr({stroke:"red"});this.container_id=b.substr(1);this.pt=document.getElementById(this.container_id).createSVGPoint();
this.g};a.prototype.setMidiData=function(b,a){var c=this._getNoteInfos(b);return this._buildNoteMeshes(c,a)};a.prototype._handleTabClick=function(b){this.pt.x=b.clientX;this.pt.y=b.clientY;b=(this.pt.matrixTransform(document.getElementById(this.container_id).getScreenCTM().inverse()).x-this.cursor.attr("transform").localMatrix.e)/this.lengthScale;return"function"===typeof this.clicktabCallback?this.clicktabCallback(b):void 0};a.prototype._getNoteInfos=function(b){var a;var d=0;var f=[];var m=[];var h=
0;for(a=b.length;h<a;h++){var e=b[h];var l=e[0];var k=l.event;e=e[1];d+=e;var n=k.subtype;e=k.noteNumber;l=k.technical;k=k.channel;9!==k&&("noteOn"===n?m[e]=d:"noteOff"===n&&(n=m[e],k=d-n,f.push({noteNumber:e,startTime:n,duration:k,technical:l})))}return f};a.prototype._buildNoteMeshes=function(b,a){var c=this,d;var m=function(b){return setTimeout(function(){return b(null)},0)};var h=[];var e=function(b,a){var c,d,f;var e=[];var g=Math.ceil(b.length/a);for(c=d=f=0;0<=g?d<g:d>g;c=0<=g?++d:--d)e[c]=
b.slice(f,f+a),f+=a;return e}(b,100);var l=0;for(d=e.length;l<d;l++){var k=e[l];h.push(m);h.push(function(b){return function(a){var d;var f=0;for(d=b.length;f<d;f++){var e=b[f];var g=e.technical;e=e.startTime;e=e*c.lengthScale+c.cursor_init_pos;var h=15+(g.string-1)*c.string_offset;c.model.text(e,h,g.fret.toString()).attr({fill:"#606060","font-size":12,"font-family":"Arial"});null!=g.lyric&&c._setLyric(e,g.lyric)}return a(null)}}(k))}async.series(h,function(){return c._groupNotes(a)});return this.model.click(this._handleTabClick)};
a.prototype._setLyric=function(b,a){this.model.rect(b-5,84,700,16,9,9).attr({fill:this.notes_color_map[a[0]]});return this.model.text(b,97,a).attr({"font-size":12,"font-family":"Arial"})};a.prototype._groupNotes=function(b){var a;this.g=this.model.g();var d=this.model.children();var f=0;for(a=d.length;f<a;f++){var m=d[f];"text"!==m.type&&"rect"!==m.type||this.g.add(m)}return"function"===typeof b?b():void 0};a.prototype.update=function(b){null==this.g&&this._groupNotes(function(){});b*=this.lengthScale;
var a=Math.floor(b/this.cursor_max_pos)*-this.cursor_max_pos;b%=this.cursor_max_pos;this.cursor.transform("t"+b+",0");return this.g.transform("t"+a+",0")};a.prototype.on=function(b,a){return this[b+"Callback"]=a};a.prototype.lengthScale=.07;a.prototype.cursor_init_pos=2;a.prototype.cursor_max_pos=700;a.prototype.string_offset=12;a.prototype.notes_color_map={A:"#d71285",B:"#1a53ff",C:"#99ff99",D:"#ff2e2e",E:"#FF9800",F:"#f4d33d",G:"#16B84E"};return a}()}).call(this);
(function(){var d=function(a){this.fretnote=a;this.notes_on=[];this.notes_off=[]};d.prototype.init=function(a,b){var c=this;var d=new XMLHttpRequest;d.onload=function(){var a,g,h;var e=(new DOMParser).parseFromString(d.responseText,"text/xml");var l=e.getElementsByTagName("technical");e.getElementsByTagName("fret");e.getElementsByTagName("string");var k=e=0;for(g=l.length-1;0<=g?e<=g:e>=g;k=0<=g?++e:--e){var n={};var p=l[k].childNodes;k=a=0;for(h=p.length-1;0<=h?a<=h:a>=h;k=0<=h?++a:--a){var q=p[k].nodeName;
switch(q){case "fret":n.fret=p[k].textContent.toString();break;case "string":n.string=p[k].textContent.toString();break;case "lyric":n.lyric=p[k].textContent.toString()}}c.notes_on.push(n)}c.notes_off=c.notes_on.slice();return"function"===typeof b?b():void 0};d.open("GET",a,!0);return d.send()};d.prototype.getNextNoteOn=function(a){if(a===this.fretnote.technicalNote(this.notes_on[0]))return this.notes_on.shift();console.log("ERROR #T1");return 1};d.prototype.getNextNoteOff=function(a){var b,c;var d=
b=0;for(c=this.notes_off.length-1;0<=c?b<=c:b>=c;d=0<=c?++b:--b)if(a===this.fretnote.technicalNote(this.notes_off[d]))return a=this.notes_off[d],this.notes_off.splice(d,1),a};this.TechnicalNotes=d}).call(this);
